include Rake

CFLAGS="-g -O2 -Wall -Wextra -Isrc -rdynamic -DNDEBUG"

SOURCES=FileList.new "src/**/*.c","src/*.c"
OBJECTS=SOURCES.ext "o"

TESTS_SRC=FileList.new("tests/*_tests.c")
TESTS=TESTS_SRC.ext ''

TARGET="build/liblcthw.a"
SO_TARGET=TARGET.ext "so"

PROGRAMS_SRC=FileList.new "bin/*.c"
PROGRAMS=PROGRAMS_SRC.ext ""

directory "build"
directory "bin"

task :default => [TARGET, SO_TARGET, :tests]#, PROGRAMS]

task TARGET => ["build", *OBJECTS] do |t|
    execute "ar rcs #{t} #{OBJECTS}"
    execute "ranlib #{t}"
end

task SO_TARGET => [TARGET, *OBJECTS] do |t|
    execute "cc -shared -o #{t} #{OBJECTS}"
end

rule ".o" => ".c" do |t|
    execute "cc #{CFLAGS} -c #{t.source} -o #{t.name}"
end

TESTS.each do |f| 
    file f => f.ext("c") do |t|
        execute "cc #{CFLAGS} #{TARGET} #{t.source} -o #{t.name}"
    end
end
task :tests => [TARGET, *TESTS] do
    puts "now run those suckers"
end

def execute(cmd)
    puts(cmd)
    `#{cmd}`
end
